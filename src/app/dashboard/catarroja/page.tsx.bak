'use client';

import { useState, useEffect, useRef } from 'react';
import dynamic from 'next/dynamic';
import { toast } from 'react-hot-toast';
import { MagnifyingGlassIcon, MapPinIcon, TableCellsIcon, DocumentTextIcon } from '@heroicons/react/24/outline';
import L from 'leaflet';
import { Zone } from '@/app/dashboard/zones/actions';
import fs from 'fs';
import path from 'path';
import { parse } from 'papaparse';
import { CatastroProperty } from '@/types/property';

// Importar el mapa dinámicamente para evitar errores de SSR
const DynamicMap = dynamic(() => import('@/components/map/DynamicMap'), {
  ssr: false,
  loading: () => <div className="h-[600px] w-full bg-gray-100 animate-pulse" />
});

// Definir la interfaz para las direcciones
interface Address {
  id: string;
  street: string;
  number: string;
  portal?: string;
  floor?: string;
  door?: string;
  postalCode: string;
  city: string;
  province: string;
  lat: number;
  lng: number;
  notes?: string;
}

// Definir interfaz para registros del catastro
interface CatastroRecord {
  referenciaCatastral: string;
  tipoVia: string;
  nombreVia: string;
  numero: string;
  bloque: string;
  escalera: string;
  planta: string;
  puerta: string;
  tipoReforma: string;
  antiguedad: string;
  calidad: string;
  superficieConstruida: string;
  tipo: string;
  lat?: number;
  lng?: number;
}

// Datos de ejemplo de zonas en Catarroja
const sampleZones: Zone[] = [
  {
    id: 'zona1',
    name: 'Centro',
    description: 'Zona centro de Catarroja',
    color: '#FF5733',
    coordinates: [
      { lat: 39.403, lng: -0.405 },
      { lat: 39.403, lng: -0.400 },
      { lat: 39.400, lng: -0.400 },
      { lat: 39.400, lng: -0.405 }
    ],
    createdAt: new Date(),
    updatedAt: new Date()
  },
  {
    id: 'zona2',
    name: 'Norte',
    description: 'Zona norte de Catarroja',
    color: '#33A8FF',
    coordinates: [
      { lat: 39.405, lng: -0.405 },
      { lat: 39.405, lng: -0.400 },
      { lat: 39.403, lng: -0.400 },
      { lat: 39.403, lng: -0.405 }
    ],
    createdAt: new Date(),
    updatedAt: new Date()
  },
  {
    id: 'zona3',
    name: 'Sur',
    description: 'Zona sur de Catarroja',
    color: '#33FF57',
    coordinates: [
      { lat: 39.400, lng: -0.405 },
      { lat: 39.400, lng: -0.400 },
      { lat: 39.397, lng: -0.400 },
      { lat: 39.397, lng: -0.405 }
    ],
    createdAt: new Date(),
    updatedAt: new Date()
  }
];

// Datos de ejemplo de direcciones en Catarroja
const sampleAddresses: Address[] = [
  {
    id: '1',
    street: 'Calle Miguel Hernández',
    number: '15',
    portal: 'A',
    floor: '3',
    door: '12',
    postalCode: '46470',
    city: 'Catarroja',
    province: 'Valencia',
    lat: 39.4012,
    lng: -0.4005,
    notes: 'Cerca del ayuntamiento'
  },
  {
    id: '2',
    street: 'Avenida Rambleta',
    number: '32',
    portal: 'B',
    floor: '1',
    door: '3',
    postalCode: '46470',
    city: 'Catarroja',
    province: 'Valencia',
    lat: 39.4025,
    lng: -0.4051,
    notes: 'Frente al parque'
  },
  {
    id: '3',
    street: 'Calle Torrent',
    number: '5',
    postalCode: '46470',
    city: 'Catarroja',
    province: 'Valencia',
    lat: 39.3982,
    lng: -0.4033,
    notes: 'Zona comercial'
  },
  {
    id: '4',
    street: 'Calle Nou',
    number: '21',
    portal: 'C',
    floor: '2',
    door: '7',
    postalCode: '46470',
    city: 'Catarroja',
    province: 'Valencia',
    lat: 39.3995,
    lng: -0.4018,
    notes: 'Edificio moderno'
  },
  {
    id: '5',
    street: 'Calle Alicante',
    number: '8',
    postalCode: '46470',
    city: 'Catarroja',
    province: 'Valencia',
    lat: 39.4030,
    lng: -0.4067,
    notes: 'Cerca de la estación'
  },
  {
    id: '6',
    street: 'Calle Mayor',
    number: '43',
    portal: 'D',
    floor: '4',
    door: '15',
    postalCode: '46470',
    city: 'Catarroja',
    province: 'Valencia',
    lat: 39.4015,
    lng: -0.4027,
    notes: 'Centro histórico'
  }
];

// Función para cargar el CSV del catastro
async function loadCatastroData(): Promise<CatastroProperty[]> {
  try {
    const response = await fetch('/api/catastro/data');
    if (!response.ok) {
      throw new Error('No se pudo cargar el archivo del catastro');
    }
    const responseData = await response.json();
    
    if (!responseData.success) {
      throw new Error(responseData.message || 'Error desconocido al cargar datos');
    }
    
    return responseData.data;
  } catch (error) {
    console.error("Error cargando datos del catastro:", error);
    return [];
  }
}

// Función para convertir registros del catastro a direcciones
function convertCatastroToAddresses(catastroRecords: CatastroProperty[]): Address[] {
  return catastroRecords.map((record, index) => {
    return {
      id: record.reference || `id-${index}`,
      street: `${record.streetType} ${record.streetName}`,
      number: record.number || '',
      portal: record.block?.trim() || undefined,
      floor: record.floor?.trim() || undefined,
      door: record.door?.trim() || undefined,
      postalCode: '46470',
      city: 'Catarroja',
      province: 'Valencia',
      lat: record.lat || 39.4015, // Default si no hay coordenadas
      lng: record.lng || -0.4027,
      notes: `${record.propertyType || ''} - ${record.constructedArea || ''}m² - Año ${record.age || ''}`
    };
  });
}

export default function CatarrojaPage() {
  const [addresses, setAddresses] = useState<Address[]>([]);
  const [catastroAddresses, setCatastroAddresses] = useState<Address[]>([]);
  const [catastroProperties, setCatastroProperties] = useState<CatastroProperty[]>([]);
  const [showCatastro, setShowCatastro] = useState(true);
  const [loading, setLoading] = useState(true);
  const [zones, setZones] = useState<Zone[]>(sampleZones);
  const [selectedAddressId, setSelectedAddressId] = useState<string | null>(null);
  const [selectedZoneId, setSelectedZoneId] = useState<string | null>(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [filteredAddresses, setFilteredAddresses] = useState<Address[]>([]);
  const [visibleAddresses, setVisibleAddresses] = useState<Address[]>([]);
  const [pagination, setPagination] = useState({
    currentPage: 1,
    pageSize: 100,
    totalItems: 0,
  });
  const [markerRefs, setMarkerRefs] = useState<{ [key: string]: L.Marker | null }>({});
  const [mapCenter, setMapCenter] = useState<[number, number]>([39.4015, -0.4027]);
  const [mapZoom, setMapZoom] = useState(15);
  const [isZoneSelected, setIsZoneSelected] = useState(false);
  const [selectedZone, setSelectedZone] = useState<Zone | null>(null);
  const mapRef = useRef<L.Map | null>(null);
  
  // Cargar datos del catastro
  useEffect(() => {
    async function fetchCatastroData() {
      setLoading(true);
      try {
        const catastroRecords = await loadCatastroData();
        console.log(`Loaded ${catastroRecords.length} cadastral records`);
        
        if (catastroRecords.length > 0) {
          // Store original catastro properties
          setCatastroProperties(catastroRecords);
          
          // Convert to Address format for compatibility with existing code
          const addresses = convertCatastroToAddresses(catastroRecords);
          setCatastroAddresses(addresses);
          // Set as current addresses since we want to show catastro by default
          setAddresses(addresses);
          toast.success(`${addresses.length} direcciones del catastro cargadas`);
        } else {
          // If no catastro data, fall back to sample data
          setAddresses(sampleAddresses);
          setShowCatastro(false);
          toast.error("No hay datos del catastro disponibles");
        }
      } catch (error) {
        console.error("Error al procesar datos del catastro:", error);
        toast.error("No se pudieron cargar los datos del catastro");
        // Fallback to sample addresses
        setAddresses(sampleAddresses);
        setShowCatastro(false);
      } finally {
        setLoading(false);
      }
    }
    
    fetchCatastroData();
  }, []);
  
  // Alternar entre direcciones de muestra y del catastro
  const toggleCatastroData = () => {
    if (catastroAddresses.length === 0) {
      toast.error("Los datos del catastro no están disponibles");
      return;
    }
    
    setShowCatastro(!showCatastro);
    if (!showCatastro) {
      // Mostrar datos del catastro (todos los registros)
      setAddresses(catastroAddresses);
      toast.success(`Mostrando ${catastroAddresses.length} datos del catastro`);
    } else {
      // Volver a datos de muestra
      setAddresses(sampleAddresses);
      toast.success("Mostrando datos de muestra");
    }
  };
  
  // Filtrar direcciones según término de búsqueda y zona seleccionada
  useEffect(() => {
    let addressesToFilter = addresses;
    
    // Si hay una zona seleccionada, filtrar primero por zona
    if (isZoneSelected && selectedZone) {
      addressesToFilter = addresses.filter(address => 
        isAddressInZone(address, selectedZone.coordinates)
      );
    }
    
    // Luego aplicar el filtro de búsqueda
    if (searchTerm.trim()) {
      const lowerCaseSearchTerm = searchTerm.toLowerCase();
      addressesToFilter = addressesToFilter.filter(address => 
        address.street.toLowerCase().includes(lowerCaseSearchTerm) ||
        address.number.toLowerCase().includes(lowerCaseSearchTerm) ||
        (address.notes && address.notes.toLowerCase().includes(lowerCaseSearchTerm))
      );
    }
    
    setFilteredAddresses(addressesToFilter);
    setPagination(prev => ({
      ...prev,
      currentPage: 1,
      totalItems: addressesToFilter.length
    }));
  }, [searchTerm, addresses, isZoneSelected, selectedZone]);
  
  // Update visible addresses when pagination or filtered addresses change
  useEffect(() => {
    const { currentPage, pageSize } = pagination;
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    setVisibleAddresses(filteredAddresses.slice(startIndex, endIndex));
  }, [filteredAddresses, pagination]);
  
  // Handle page change
  const handlePageChange = (page: number) => {
    setPagination(prev => ({
      ...prev,
      currentPage: page
    }));
  };

  // Función para verificar si una dirección está dentro de una zona
  const isAddressInZone = (address: Address, zoneCoordinates: { lat: number; lng: number }[]) => {
    if (!address.lat || !address.lng) return false;
    
    const point = { lat: address.lat, lng: address.lng };
    let inside = false;
    
    for (let i = 0, j = zoneCoordinates.length - 1; i < zoneCoordinates.length; j = i++) {
      const { lat: lati, lng: lngi } = zoneCoordinates[i];
      const { lat: latj, lng: lngj } = zoneCoordinates[j];
      
      const intersect = ((lati > point.lat) !== (latj > point.lat)) &&
        (point.lng < (lngj - lngi) * (point.lat - lati) / (latj - lati) + lngi);
      
      if (intersect) inside = !inside;
    }
    
    return inside;
  };

  // Manejar clic en zona
  const handleZoneClick = (zone: Zone) => {
    setSelectedZone(zone);
    setSelectedZoneId(zone.id);
    setIsZoneSelected(true);
    
    // Centrar el mapa en la zona
    const lats = zone.coordinates.map(c => c.lat);
    const lngs = zone.coordinates.map(c => c.lng);
    const centerLat = (Math.min(...lats) + Math.max(...lats)) / 2;
    const centerLng = (Math.min(...lngs) + Math.max(...lngs)) / 2;
    
    setMapCenter([centerLat, centerLng]);
    setMapZoom(15);
    
    // Contar direcciones en la zona
    const addressesInZone = addresses.filter(address => 
      isAddressInZone(address, zone.coordinates)
    );
    
    toast.success(`${addressesInZone.length} direcciones encontradas en la zona ${zone.name}`);
  };

  // Resetear selección de zona
  const resetZoneSelection = () => {
    setSelectedZone(null);
    setSelectedZoneId(null);
    setIsZoneSelected(false);
    setMapCenter([39.4015, -0.4027]);
    setMapZoom(15);
  };

  // Handle when a marker is clicked
  const handleMarkerClick = (addressId: string) => {
    setSelectedAddressId(addressId);
    const selectedAddress = [...addresses, ...catastroAddresses].find(a => a.id === addressId);
    if (selectedAddress) {
      // Center map on the selected address
      setMapCenter([selectedAddress.lat, selectedAddress.lng]);
      setMapZoom(17);
    }
  };

  // Manejar envío del formulario de búsqueda
  const handleSearchSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    // Buscar direcciones por término
  };

  // Función que devolvería los marcadores para el mapa
  const getMapProperties = () => {
    return addresses.map(address => ({
      id: address.id,
      address: `${address.street}, ${address.number}`,
      population: address.city,
      status: 'SALE' as const,
      action: 'IR_A_DIRECCION' as const,
      type: 'PISO' as const,
      ownerName: '',
      ownerPhone: '',
      captureDate: new Date().toISOString(),
      responsibleId: null,
      hasSimpleNote: false,
      isOccupied: false,
      clientId: null,
      zoneId: null,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      latitude: address.lat,
      longitude: address.lng,
      occupiedBy: null,
      isLocated: true,
      responsible: null,
      activities: [],
      zone: null,
      assignments: [],
      dpv: null,
      clients: [],
      responsibleUser: null,
      habitaciones: null,
      banos: null,
      metrosCuadrados: null,
      parking: false,
      ascensor: false,
      piscina: false,
      price: '0',
      description: address.notes || '',
      yearBuilt: '',
      isFurnished: false,
      ownerEmail: '',
      tenantName: '',
      tenantPhone: '',
      tenantEmail: '',
      notes: address.notes || '',
      title: `${address.street}, ${address.number}${address.portal ? `, portal ${address.portal}` : ''}${address.floor ? `, piso ${address.floor}` : ''}${address.door ? `, puerta ${address.door}` : ''}`
    }));
  };

  return (
    <div className="space-y-6">
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Mapa de Direcciones de Catarroja</h1>
          <p className="mt-1 text-sm text-gray-500">
            Visualiza y busca direcciones detalladas en Catarroja
          </p>
        </div>
        
        <div className="flex gap-2">
          <button 
            onClick={toggleCatastroData}
            className={`px-3 py-2 rounded-md ${showCatastro ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700'} flex items-center`}
            disabled={catastroAddresses.length === 0 || loading}
          >
            {loading ? (
              <span className="flex items-center">
                <svg className="animate-spin -ml-1 mr-2 h-4 w-4 text-current" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Cargando...
              </span>
            ) : (
              <>
                <DocumentTextIcon className="h-4 w-4 mr-1" />
                {showCatastro ? 'Ver muestra' : 'Ver catastro'}
              </>
            )}
          </button>
          
          <form onSubmit={handleSearchSubmit} className="relative w-full sm:w-72">
            <div className="relative">
              <input
                type="text"
                placeholder="Buscar por calle, número..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 pl-10"
              />
              <button
                type="submit"
                className="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500"
              >
                <MagnifyingGlassIcon className="h-5 w-5" />
              </button>
            </div>
          </form>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Lista de direcciones */}
        <div className="lg:col-span-1 bg-white rounded-lg shadow overflow-hidden">
          <div className="p-4 border-b border-gray-200 flex justify-between items-center">
            <h2 className="font-medium text-gray-700">
              {isZoneSelected 
                ? `${selectedZone?.name} (${filteredAddresses.length})` 
                : `${showCatastro ? 'Catastro' : 'Muestra'} (${filteredAddresses.length})`}
            </h2>
            {isZoneSelected && (
              <button 
                onClick={resetZoneSelection}
                className="text-xs text-blue-600 hover:text-blue-800 font-medium"
              >
                Ver todas
              </button>
            )}
          </div>
          
          {isZoneSelected && selectedZone && (
            <div className="bg-blue-50 p-3 border-b border-blue-100">
              <div className="flex items-center">
                <div 
                  className="w-4 h-4 rounded-full mr-2" 
                  style={{ backgroundColor: selectedZone.color }}
                ></div>
                <div>
                  <p className="text-sm font-medium text-gray-800">{selectedZone.name}</p>
                  <p className="text-xs text-gray-500">{selectedZone.description}</p>
                </div>
              </div>
            </div>
          )}
          
          {/* Address list with pagination */}
          <div className="overflow-y-auto max-h-[450px]">
            {loading ? (
              <div className="flex items-center justify-center py-8">
                <svg className="animate-spin h-8 w-8 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                  <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                  <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </div>
            ) : filteredAddresses.length > 0 ? (
              <>
                <div className="p-2 bg-gray-50 border-b border-gray-200 text-xs text-gray-500">
                  Mostrando {visibleAddresses.length} de {filteredAddresses.length} resultados
                </div>
                <ul className="divide-y divide-gray-200">
                  {visibleAddresses.map((address) => (
                    <li 
                      key={address.id}
                      className={`p-4 cursor-pointer hover:bg-gray-50 ${selectedAddressId === address.id ? 'bg-gray-50 border-l-4 border-blue-500' : ''}`}
                      onClick={() => handleMarkerClick(address.id)}
                    >
                      <div className="flex flex-col">
                        <h3 className="font-medium text-gray-900">{address.street}, {address.number}</h3>
                        <p className="text-sm text-gray-500">
                          {address.portal && `Portal ${address.portal}, `}
                          {address.floor && `Piso ${address.floor}, `}
                          {address.door && `Puerta ${address.door}`}
                        </p>
                        <p className="text-sm text-gray-500">{address.postalCode} {address.city}</p>
                        {address.notes && (
                          <p className="mt-1 text-xs text-gray-500 italic">{address.notes}</p>
                        )}
                      </div>
                    </li>
                  ))}
                </ul>
                
                {/* Pagination controls */}
                {filteredAddresses.length > pagination.pageSize && (
                  <div className="p-2 border-t border-gray-200 flex justify-between items-center bg-white">
                    <button
                      className="px-2 py-1 text-sm text-gray-700 rounded hover:bg-gray-100 disabled:opacity-50"
                      disabled={pagination.currentPage === 1}
                      onClick={() => handlePageChange(pagination.currentPage - 1)}
                    >
                      Anterior
                    </button>
                    <span className="text-sm text-gray-500">
                      Página {pagination.currentPage} de {Math.ceil(filteredAddresses.length / pagination.pageSize)}
                    </span>
                    <button
                      className="px-2 py-1 text-sm text-gray-700 rounded hover:bg-gray-100 disabled:opacity-50"
                      disabled={pagination.currentPage >= Math.ceil(filteredAddresses.length / pagination.pageSize)}
                      onClick={() => handlePageChange(pagination.currentPage + 1)}
                    >
                      Siguiente
                    </button>
                  </div>
                )}
              </>
            ) : (
              <div className="p-4 text-center text-gray-500">
                No se encontraron direcciones
                {isZoneSelected && (
                  <div className="mt-2">
                    <button 
                      onClick={resetZoneSelection}
                      className="text-blue-600 hover:text-blue-800 font-medium text-sm"
                    >
                      Ver todas las direcciones
                    </button>
                  </div>
                )}
              </div>
            )}
          </div>
        </div>
        
        {/* Mapa */}
        <div className="lg:col-span-2 bg-white rounded-lg shadow overflow-hidden h-[600px]">
          <div className="p-3 border-b border-gray-200 flex justify-between items-center">
            <h2 className="font-medium text-gray-700">
              {showCatastro ? `Mapa Catastral (${catastroProperties.length} propiedades)` : `Mapa (${addresses.length} direcciones)`}
            </h2>
          </div>
          <DynamicMap 
            addresses={addresses}
            center={mapCenter}
            zoom={mapZoom}
            onMarkerClick={handleMarkerClick}
            selectedAddressId={selectedAddressId}
            catastroProperties={catastroProperties}
            showCatastro={showCatastro}
          />
        </div>
      </div>
    </div>
  );
} 